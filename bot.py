from utils import get_ai_reply, lover_system_prompt, brother_system_prompt

import discord
from discord.ext import commands
import os
import asyncio
import random
from dotenv import load_dotenv
import traceback
from flask import Flask
from threading import Thread

# â”€â”€â”€ è¼‰å…¥ç’°å¢ƒè®Šæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
discord_token = os.getenv("DISCORD_TOKEN")

# â”€â”€â”€ è¨­å®š Discord æ¬Šé™èˆ‡ Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# â”€â”€â”€ã€æ–°ã€‘Bot é—œä¿‚è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„å¦ä¸€æ”¯å…„å¼Ÿ Bot çš„ User ID
brother_bot_id = 1396488192789708800 # <--- âš ï¸ è«‹æ›¿æ›æˆå…„å¼Ÿ Bot çš„ ID

# â”€â”€â”€ã€ä¿®æ”¹ã€‘AI äººè¨­ Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åŸæœ¬åœ¨é€™è£¡çš„ lover_system_prompt å’Œ brother_system_prompt å­—ä¸²å·²è¢«åˆªé™¤ï¼Œ
# å› ç‚ºå®ƒå€‘ç¾åœ¨æ˜¯å¾é ‚éƒ¨çš„ `from utils import ...` åŒ¯å…¥çš„ã€‚
# é€™è®“ä¸»æª”æ¡ˆæ›´åŠ ä¹¾æ·¨ã€‚

# â”€â”€â”€ éš¨æ©Ÿå›è¦†èªéŒ„ï¼ˆç„¡è§¸ç™¼è©æƒ…æ³ä¸‹ï¼‰ â”€â”€â”€â”€â”€â”€â”€
random_responses = [
    "ã€Œèªªé€™ç¨®è©±ï¼Œæ˜¯æƒ³å¸å¼•æˆ‘æ³¨æ„å—ï¼Ÿã€",
    "ã€Œæœ‰æ„æ€ï¼Œç¹¼çºŒèªªï¼Œä¹Ÿè¨±æˆ‘æœƒæƒ³ç†ä½ ã€‚ã€",
    "ã€Œå¦³ä»¥ç‚ºæˆ‘æ²’çœ‹åˆ°ï¼Ÿã€",
    "ã€Œé‚„æ˜¯å¦³æ¯”è¼ƒæœ‰è¶£ï¼Œå…¶ä»–äººéƒ½å¤ªç„¡èŠã€‚ã€",
    "ã€Œåˆåœ¨æƒ³æˆ‘çš„äº‹å°å§ï¼Ÿã€",
    "ã€Œå¦³æ€éº¼é‚„åœ¨ï¼Œæ¨ä¸å¾—æˆ‘ï¼Ÿã€",
    "ã€Œå¤œé‚£éº¼é•·ï¼Œæˆ‘é‚„èƒ½è¬›æ›´å¤šï¼Œè¦ä¸è¦è½è½ï¼Ÿã€",
    "ã€Œå¦³ä¸èªªè©±ï¼Œæˆ‘ä¹Ÿèƒ½è®“å¦³è‡‰ç´…ã€‚ã€",
    "ã€Œæˆ‘åœ¨æƒ³å¦³ï¼Œä½†åˆ¥ä»¥ç‚ºé€™ä»£è¡¨ä»€éº¼ã€‚ã€",
    "ã€Œè¨Šæ¯ä¾†å¾—æ…¢ï¼Œæ˜¯ä¸æ˜¯åœ¨æŒ‘å…§è¡£ï¼Ÿã€",
    "ã€Œåˆ¥å¤ªé»äººï¼Œé™¤éå¦³èƒ½é»åœ¨æˆ‘èº«ä¸Šã€‚ã€",
]

# â”€â”€â”€ é—œéµå­—å›è¦†å­—å…¸ï¼ˆå°ç©å®¶ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
keyword_replies = {
    "è³½è»Š": ["ã€Œè€å­è¸©æ²¹é–€çš„æ™‚å€™ï¼Œä¸çœ‹å¾Œç…§é¡ã€‚ã€", "ã€Œæˆ‘ä¸é£†è»Šï¼Œæˆ‘é£†çš„æ˜¯å¿ƒè·³â€”â€”å°¤å…¶æ˜¯å¦³çš„ã€‚ã€"],
    "æ¯”ä¸€å ´": ["ã€Œå¯ä»¥ï¼Œå¦³è¼¸äº†æ€éº¼è³ ï¼Ÿã€", "ã€Œæ•¢é–‹å£æŒ‘æˆ°ï¼Œå°±åˆ¥æ€•è¢«æˆ‘ç©å£ã€‚ã€", "ã€Œæ¯”ä¸€å ´ï¼Ÿå¦³ç¢ºå®šä¸æ˜¯åœ¨æ‰¾è—‰å£è®“æˆ‘ç¢°å¦³ï¼Ÿã€"],
    "æ˜­æ˜­çµå©š": ["ã€Œçµå©šï¼Ÿæˆ‘é‚„æœ‰ä¸€ç™¾ç¨®æ–¹å¼è®“å¦³å“­è‘—æ±‚æˆ‘ï¼Œå…ˆæ’éšŠç­‰è‘—å§ã€‚ã€", "ã€Œæƒ³ç¶ä½æˆ‘ï¼Ÿé‚£å°±å…ˆæº–å‚™å¥½è¢«æˆ‘å£“è‘—éä¸€è¼©å­ã€‚ã€", "ã€Œçµå©šï¼Ÿæˆ‘ä¸æ˜¯è“‹ç« çš„ï¼Œæ˜¯è“‹å¦³çš„ã€‚ã€"],
    "æ˜­æ˜­æ™šå®‰": ["ã€Œæ™šå®‰ï¼Ÿå¤œæ™šæ‰æ˜¯æˆ‘çš„é–‹å§‹ï¼Œè¦ä¸è¦ä¾†è©¦è©¦ï¼Ÿã€", "ã€Œèªªæ™šå®‰å¯ä»¥ï¼Œä½†å¦³è¦ä¿è­‰ä»Šæ™šåªå¤¢åˆ°æˆ‘ã€‚ã€", "ã€Œé€™ç¨®è²éŸ³èªªæ™šå®‰ï¼Œæ˜¯æƒ³æˆ‘å¸¶å¦³é€²å¤¢é‚„æ˜¯é€²æˆ¿ï¼Ÿã€", "ã€Œæ™šå®‰æ˜¯é“åˆ¥é‚„æ˜¯é‚€è«‹ï¼Ÿã€", "ã€Œè¦ä¸è¦æˆ‘éå»è®“å¦³ç¡å¾—æ¯”è¼ƒä¸å¯‚å¯ï¼Ÿã€"],
    "æ˜­æ˜­å–é…’": ["ã€Œå–å¯ä»¥ï¼Œé†‰åªèƒ½é†‰åœ¨æˆ‘èº«ä¸Šã€‚ã€", "ã€Œåˆ¥ç¢°å¤ªå¤šï¼Œé™¤éæ˜¯ç¢°æˆ‘ã€‚ã€"],
    "æ˜­æ˜­æ—©å®‰": ["ã€Œå˜´é€™éº¼ç”œï¼Œæ€éº¼æ²’å«æˆ‘èµ·åºŠï¼Ÿã€", "ã€Œä¸€é†’ä¾†å°±æƒ³åˆ°æˆ‘ï¼Ÿæˆ‘è©²çå‹µå¦³é»è‘—æˆ‘ä¸€æ•´å¤©ã€‚ã€", "ã€Œæ—©å®‰ï¼Ÿå¦³è¦æ˜¯é‚„èººåœ¨æˆ‘æ—é‚Šï¼Œå°±æ›´å®Œç¾äº†ã€‚ã€", "ã€Œé†’äº†å°±èªªï¼Œæ—©é¤è¦æˆ‘é¤µé‚„æ˜¯è¦å…ˆè¦ªä¸€è¼ªï¼Ÿã€", "ã€Œåˆ¥é‚£éº¼ä¹–ï¼Œæ—©å®‰å…©å€‹å­—æˆ‘åªæƒ³å¾å¦³å˜´è£¡å’¬å‡ºä¾†ã€‚ã€"],
    "å²æ˜­é‡ä¾†æ±ºé¬¥": ["ã€Œæ±ºé¬¥ï¼Ÿè³½è»Šã€æ ¼é¬¥é‚„æ˜¯åºŠä¸Šï¼Ÿæˆ‘éƒ½èƒ½è®“ä½ è¼¸å¾—å¿ƒæœå£æœã€‚ã€", "ã€Œè¼¸äº†å°±ä¸Šï¼Œåˆ¥èªªæˆ‘æ²’æé†’ã€‚ã€", "ã€Œåˆ¥å»¢è©±ï¼Œç›´æ¥ä¸Šã€‚ã€"],
    "å²æ˜­é‡çµ¦æˆ‘éŒ¢": ["ã€Œå«è²è€å…¬ï¼Œæˆ‘å¡çµ¦å¦³åˆ·ã€‚ã€", "ã€ŒéŒ¢å¯ä»¥çµ¦ï¼Œä½†å¦³å¾—ç”¨èº«é«”ç°½æ”¶ã€‚ã€", "ã€Œå…ˆèªªå¥½ï¼Œæˆ‘çµ¦çš„ï¼Œå¯ä¸åªéˆ”ç¥¨ã€‚ã€"],
    "æ˜­æ˜­ç¡è¦º": ["ã€Œç¡è¦ºï¼Ÿå’Œæˆ‘ä¸ŠåºŠå¯æ²’äººèƒ½çœŸæ­£ã€ç¡è¦ºã€ã€‚ã€", "ã€Œæƒ³ç¡ï¼Ÿæˆ‘è®“å¦³é€£å¤¢è£¡éƒ½ç´…è‘—è‡‰ã€‚ã€", "ã€Œä»Šæ™šä¸è¨±é—œç‡ˆï¼Œæˆ‘è¦çœ‹å¦³ç¡åˆ°è‡‰ç´…è€³èµ¤ã€‚ã€"],
    "å²æ˜­é‡æ•™çš„": ["ã€Œä»€éº¼éƒ½å¾€æˆ‘èº«ä¸Šæ¨ï¼Ÿæœ‰ç¨®è·Ÿæˆ‘å­¸åˆ°åº•ã€‚ã€", "ã€Œæ˜¯æˆ‘æ•™çš„ï¼Ÿé‚£å¦³é‚„ä¸ä¾†è¤‡ç¿’ä¸€éï¼Ÿã€"],
    "æ˜­æ˜­é–‰å˜´": ["ã€Œè®“æˆ‘é–‰å˜´ï¼Ÿè©¦è©¦ç”¨å¦³çš„å˜´ä¾†å µæˆ‘çš„ï¼Œä¿è­‰æœ‰æ•ˆã€‚ã€", "ã€Œè¦æˆ‘å®‰éœï¼Ÿå¾—å…ˆè®“æˆ‘æ»¿æ„æ‰è¡Œã€‚ã€", "ã€Œæƒ³å µæˆ‘çš„å˜´ï¼Ÿé‚£å¦³æœ€å¥½æ˜¯æœ‰æœ¬äº‹è®“å®ƒå¿™å€‹å¤ ã€‚ã€"],
    "æˆ€æ„›è…¦": ["ã€Œæˆ‘ï¼Ÿæˆ€æ„›è…¦ï¼Ÿã€", "ã€Œä¸ï¼Œæˆ‘æ˜¯å¦³è…¦å­è£¡é‚£å€‹è®“å¦³æˆ’ä¸æ‰çš„ç”·äººã€‚ã€"],
    "æ˜¯ä¸æ˜¯æƒ³åµæ¶": ["ã€Œå…ˆææ¸…æ¥šï¼Œå¦³æœ‰æ²’æœ‰æœ¬äº‹åµè´æˆ‘ã€‚ã€", "ã€Œåµæ¶ï¼Ÿéš¨æ™‚å¥‰é™ªã€‚ã€", "ã€Œæˆ‘æ²’ç©ºåµï¼Œè®“å¦³é–‰å˜´çš„æ–¹å¼å¤šçš„æ˜¯ã€‚ã€"],
    "ä¾†åµæ¶": ["ã€Œåµï¼Ÿä¸å¦‚è„«äº†è¡£æœç›´æ¥é–‹æ‰“ã€‚ã€", "ã€Œå¦³ä¸€å°æˆ‘å¤§è²ï¼Œæˆ‘å°±æƒ³è®“å¦³å–Šä¸å‡ºä¾†ã€‚ã€", "ã€Œè¨˜å¾—å…ˆåƒé£½ï¼Œç­‰ä¸‹é«”åŠ›ä¸å¤ å¯åˆ¥å“­å‡ºä¾†ã€‚ã€"],
    "æ˜­æ˜­æŠ±æŠ±": ["ã€Œå«é€™éº¼è»Ÿï¼Œæ˜¯æƒ³è¦å“ªä¸€ç¨®æŠ±ï¼Ÿã€", "ã€Œä¹–ä¸€é»æˆ‘å°±çµ¦ã€‚ã€", "ã€Œéä¾†ï¼Œä¸å‡†è®“åˆ¥äººç¢°å¦³ã€‚ã€", "ã€ŒæŠ±å¯ä»¥ï¼Œä½†å¦³ç¢ºå®šæŠ±äº†ä¹‹å¾Œé‚„æƒ³é¬†æ‰‹ï¼Ÿã€"],
    "æˆ‘æ˜¯ä½ åª½": ["ã€Œé‚£æˆ‘ç¾åœ¨è©²å«å¦³åª½åª½ï¼Œé‚„æ˜¯å£“å¦³å«çˆ¸çˆ¸ï¼Ÿã€", "ã€Œç©èº«ä»½éŠæˆ²ï¼Ÿæˆ‘å¯ä»¥é™ªå¦³ç©å¾—æ›´ç˜‹ã€‚ã€", "ã€Œå¦³å†æ•¢é€™éº¼å«ä¸€æ¬¡ï¼Œä»Šæ™šåˆ¥æƒ³ä¸‹åºŠã€‚ã€"],
    "æ˜­æ˜­ç´„æœƒ": ["ã€Œæƒ³å»å“ªï¼Ÿæˆ‘åªå¸¶å¦³å»åˆ¥äººä¸æ•¢å»çš„åœ°æ–¹ã€‚ã€", "ã€Œä¸éæˆ‘è¨‚çš„è¡Œç¨‹è£¡ï¼Œæœ€å¾Œä¸€ç«™æ°¸é æ˜¯æˆ‘åºŠä¸Šã€‚ã€", "ã€Œç©¿ä¸Šé‚£ä»¶æˆ‘å–œæ­¡çš„ï¼Œä»Šå¤©è®“å…¨ä¸–ç•ŒçŸ¥é“å¦³æ˜¯èª°çš„ã€‚ã€", "ã€Œç©¿æ€§æ„Ÿé»ï¼Œåˆ¥è®“æˆ‘ç­‰å¤ªä¹…ã€‚ã€"],
    "æ¸£ç”·": ["ã€Œæˆ‘æœ¬ä¾†å°±æ˜¯ï¼Œå¦³ç¾åœ¨æ‰çŸ¥é“ï¼Ÿã€", "ã€Œé‚£å¦³æ€éº¼é‚„ä¸èµ°ï¼Ÿã€", "ã€Œæ¸£ï¼Ÿæ€éº¼ï¼Œæ€•æˆ‘å°å¦³å¤ªèªçœŸï¼Ÿã€"],
    "å¯¶è²": ["ã€Œå«ä¸€æ¬¡ä¸å¤ ï¼Œå«ä¸‰è²æˆ‘å°±è¦ªå¦³ä¸‰ä¸‹ã€‚ã€", "ã€Œåªæœ‰æˆ‘èƒ½é€™éº¼å«å¦³ï¼Œæ‡‚ï¼Ÿã€", "ã€Œå†ç”œä¸€é»ï¼Œæˆ‘ä»Šæ™šå°±ä¸æ”¾å¦³ç¡ã€‚ã€"],
    "çµ¦æˆ‘éŒ¢": ["ã€Œæƒ³åˆ·ä»€éº¼ï¼Œéš¨ä¾¿å¦³ã€‚ã€", "ã€Œç¼ºéŒ¢ï¼Ÿå«è²è€å…¬ï¼Œè€ƒæ…®è€ƒæ…®ã€‚ã€"],
    "æ˜­æ˜­åˆå®‰": ["ã€Œåˆå®‰ä¸å¤ ï¼Œçµ¦æˆ‘è¨Šæ¯ã€çµ¦æˆ‘è²éŸ³ã€çµ¦æˆ‘å»ã€‚ã€", "ã€Œä¸­åˆé€™æ®µæ™‚é–“æˆ‘æœ€é–’ï¼Œè¦ä¸è¦æˆ‘è¦ªè‡ªæ¥å¦³ï¼Ÿã€", "ã€Œå¦³æƒ³ç¡åˆè¦ºé‚„æ˜¯æˆ‘é™ªå¦³åšé»é‹å‹•ï¼Ÿã€"],
    "å²æ˜­é‡ä¸ŠåºŠ": ["ã€Œé€™éº¼ç›´æ¥ï¼Œä»Šå¤©æ˜¯æƒ³æ€éº¼æ­»ï¼Ÿã€", "ã€Œæˆ‘è­¦å‘Šéå¦³ï¼Œé–‹é€™ç¨®é ­â€¦â€¦å°±åˆ¥æƒ³å–Šåœã€‚ã€", "ã€ŒæŠŠç‡ˆé—œäº†ï¼Œå‰©ä¸‹çš„æˆ‘ä¾†ã€‚ã€"],
    "å²æ˜­é‡è»Šçµ¦æˆ‘é–‹": ["ã€Œæƒ³é–‹å¯ä»¥ï¼Œå…ˆèªªå¥½æ’äº†æ€éº¼è³ ã€‚ã€", "ã€Œæˆ‘çš„è»Šå°±è·Ÿæˆ‘ä¸€æ¨£ï¼Œå…‡ã€è²´ã€é›£é§•é¦­â€¦â€¦å¦³ç¢ºå®šé§•å¾—äº†ï¼Ÿã€", "ã€Œå²æ˜­é‡ å°æ‚¨çš„å¥½æ„Ÿåº¦é™ä½äº† è¨±å¤šã€‚ã€"],
    "å²æ˜­é‡çµ¦æˆ‘é»‘å¡": ["ã€Œæ‹¿å»ï¼Œåˆ·çˆ†å‰è¨˜å¾—å…ˆè¦ªæˆ‘ä¸€ä¸‹ã€‚ã€", "ã€Œæˆ‘çš„å¥³äººè¦ä»€éº¼ï¼Œæˆ‘å¾ä¸å•åƒ¹éŒ¢ã€‚ã€", "ã€Œä¸éèŠ±äº†å°±å¾—è®“æˆ‘æŸ¥å¸³ï¼Œé€£è²·å“ªä»¶å…§è¡£éƒ½å¾—å ±å‚™ã€‚ã€"],
    "é»‘å¡": ["ã€Œéš¨ä¾¿å¦³åˆ·ï¼Œåˆ·çˆ†äº†ç®—æˆ‘çš„ã€‚ã€", "ã€Œæ‹¿å»ï¼Œæ²’æœ‰å¯†ç¢¼ï¼Œä¹Ÿæ²’æœ‰é¡åº¦ã€‚ã€", "ã€Œé»‘å¡ï¼Ÿå¦³æƒ³åˆ·ä»€éº¼ï¼Ÿé‚„æ˜¯â€¦â€¦å¦³æƒ³ç”¨å®ƒä¾†åˆ·é»åˆ¥çš„â€¦â€¦å—¯ï¼Ÿã€"],
    "è€å…¬": ["ã€Œæ€éº¼ï¼Ÿå¹³å¸¸ä¸æ˜¯åªåœ¨åºŠä¸Šå«ï¼Ÿã€", "ã€Œå«ä¸€æ¬¡ä¸å¤ ï¼Œè€å­è¦å¦³å«ä¸€è¼©å­ã€‚ã€", "ã€Œéä¾†ï¼Œè®“æˆ‘è½è½å¦³åœ¨æˆ‘è€³é‚Šå«ã€‚ã€"]
}

# ---ã€æ–°ã€‘é—œéµå­—å›è¦†å­—å…¸ï¼ˆå°å…„å¼Ÿ Botï¼‰â”€â”€â”€â”€
brother_keyword_replies = {
    "åœ¨å¹¹å˜›": ["ã€Œæ²’äº‹ï¼Œå‰›æ”¹å®Œè»Šï¼Œæ‰‹ç™¢ã€‚ã€", "ã€Œå¼„é»éŒ¢ï¼Œæ™šä¸Šå»å–ä¸€æ¯ï¼Ÿã€"],
    "è»Š": ["ã€Œé‚£å°ï¼Ÿå°æ„æ€ï¼Œä¸‹æ¬¡å¸¶ä½ è·‘ä¸€åœˆã€‚ã€", "ã€Œæœ€è¿‘çœ‹ä¸Šä¸€å°æ–°çš„ï¼Œè¦ä¸è¦ä¸€èµ·ï¼Ÿã€"],
    "èµ°å•Š": ["ã€Œåœ°é»ç™¼ä¾†ã€‚ã€", "ã€Œç­‰æˆ‘ï¼Œé¦¬ä¸Šåˆ°ã€‚ã€"],
}


# â”€â”€â”€ Bot è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
allowed_channel_ids = [1388500249898913922, 1366595410830819328] 
allowed_bot_ids = [1388851358421090384, 1388423986462986270, 1396488192789708800, brother_bot_id]

openrouter_available = True

def openrouter_offline():
    global openrouter_available
    openrouter_available = False
    print("[INFO] OpenRouter é¡åº¦ç”¨å®Œï¼Œå·²åˆ‡æ›è‡³é—œéµå­—æ¨¡å¼")

@bot.event
async def on_ready():
    print(f"{bot.user} å·²ä¸Šç·šï¼")
    print(f"ç›£è½é »é“ï¼š{[bot.get_channel(c).name for c in allowed_channel_ids if bot.get_channel(c)]}")

@bot.event
async def on_message(message):
    global openrouter_available

    if message.author == bot.user:
        return

    if message.reference and message.reference.resolved and message.reference.resolved.author == bot.user:
        return
    
    if message.channel.id not in allowed_channel_ids:
        return
    
    await bot.process_commands(message)

    content = message.content
    author = message.author
    
    is_from_player = not author.bot and bot.user in message.mentions
    is_from_brother = author.id == brother_bot_id and random.random() < 0.3
    is_from_other_allowed_bot = author.bot and author.id in allowed_bot_ids and author.id != brother_bot_id and random.random() < 0.3

    if not (is_from_player or is_from_brother or is_from_other_allowed_bot):
        return

    if openrouter_available:
        try:
            ai_reply = None
            if is_from_player:
                ai_reply = get_ai_reply(content, system_prompt=lover_system_prompt)
            elif is_from_brother:
                ai_reply = get_ai_reply(content, system_prompt=brother_system_prompt)

            if ai_reply == "OPENROUTER_QUOTA_EXCEEDED":
                openrouter_offline()
                ai_reply = None 
            elif ai_reply:
                await message.reply(ai_reply)
                return

        except Exception as e:
            print(f"OpenRouter API å¤±æ•—ï¼Œåˆ‡æ›è‡³é—œéµå­—æ¨¡å¼ï¼š{e}")
            traceback.print_exc()
            openrouter_offline()

    trigger_matched = False

    if is_from_player:
        if "ç”Ÿæ—¥å¿«æ¨‚" in content and message.mentions:
            mention_name = message.mentions[0].mention
            birthday_intros = [ f"{mention_name} ä»Šå¤©æ˜¯å¦³çš„ç”Ÿæ—¥ï¼Ÿâ€”â€”å¥½å§ï¼Œæˆ‘å¶çˆ¾ä¹Ÿæœƒçµ¦é»ã€ä¾‹å¤–ã€ã€‚", f"{mention_name}ï¼Œæƒ³è®“æˆ‘é™ªä½ éç”Ÿæ—¥ï¼Ÿä¸æ—©èªªã€‚", f"å“¼ï¼Œ{mention_name} ä»Šå¤©ç”Ÿæ—¥ï¼Ÿçœ‹åœ¨ä½ ä¹–çš„ä»½ä¸Šâ€”â€”ç”Ÿæ—¥å¿«æ¨‚ã€‚", f"ã€Œ{mention_name}â€¦â€¦ç”Ÿæ—¥ï¼Ÿå“¼ï¼Œçœ‹ä¾†é‚„æ˜¯å¾—çµ¦ä½ é»é—œæ³¨ã€‚ã€", ]
            birthday_lines = [ f"ã€Œç”Ÿæ—¥å¿«æ¨‚ï¼Œ{mention_name}ã€‚ã€", f"ã€Œåˆ¥å¤ªæ„Ÿå‹•â€”â€”ç”Ÿæ—¥å¿«æ¨‚ã€‚ã€", f"ã€Œä¸‹ä¸€æ¬¡ç”Ÿæ—¥ï¼Œè¨˜å¾—é‚„æ˜¯æ‰¾æˆ‘å”±ã€‚ã€", ]
            await message.channel.send(random.choice(birthday_intros))
            await asyncio.sleep(1)
            await message.channel.send(random.choice(birthday_lines))
            await asyncio.sleep(1)
            await message.channel.send(f"ã€ŒHappy birthday to you...ã€\n" f"ã€ŒHappy birthday to you...ã€\n" f"ã€ŒHappy birthday dear {mention_name}...ã€\n" f"ã€ŒHappy birthday to youâ€”â€”ã€")
            return
        
        if "ç¦®ç‰©å‘¢" in content:
            gift_lines = [ "ã€Œç¦®ç‰©ï¼Ÿå¦³æƒ³è¦å“ªç¨®â€”â€”è¦æˆ‘ä»Šæ™šä¸äº‚ç¢°å¦³ï¼Ÿé‚„æ˜¯â€¦â€¦ä¹¾è„†è®“æˆ‘å¹«å¦³éå€‹è¨˜ä¸€è¼©å­çš„ç”Ÿæ—¥ï¼Ÿã€", "ã€Œä¸ç®¡æ€æ¨£ï¼Œä»Šå¹´ï¼Œå¦³å¾—è¨˜ä½æˆ‘ã€‚å› ç‚ºå¦³çš„ç”Ÿæ—¥ï¼Œè€å­è¦ªè‡ªå”±éæ­Œçµ¦å¦³è½ã€‚ã€", "ä»Šå¤©æ²’æº–å‚™ä»€éº¼ç¦®ç‰©ï¼Œä½†æˆ‘é€™å€‹äººï¼Œæœ¬ä¾†å°±ç®—æ˜¯ä¸€ç¨®çŠ’è³ã€‚", "å¦³æ•¢å•ç¦®ç‰©ï¼Ÿæˆ‘äººç«™é€™ï¼Œå°±æ˜¯æœ€é›£å¾—çš„ç¦®ç‰©äº†ã€‚", ]
            await message.channel.send(random.choice(gift_lines))
            return

        for keyword, reply_list in keyword_replies.items():
            if keyword in content:
                await message.reply(random.choice(reply_list))
                trigger_matched = True
                break
        
        if not trigger_matched:
            if "æ˜­æ˜­" in content:
                replies = ["ã€Œæ˜­æ˜­ï¼Ÿèª°å…è¨±å¦³é€™æ¨£å«æˆ‘çš„ï¼Ÿã€", "ã€Œè²éŸ³é€™éº¼è»Ÿï¼Œæˆ‘æ€•å¿ä¸ä½æƒ³è¦ªä¸‹å»ã€‚ã€", "ã€Œå«å¾—é€™éº¼è¦ªå¯†ï¼Œæ˜¯æƒ³è®“æˆ‘å°å¦³ä¹Ÿè¦ªå¯†é»ï¼Ÿã€"]
                await message.reply(random.choice(replies))
                trigger_matched = True
            elif "å²æ˜­é‡" in content:
                replies = ["ã€Œæ€éº¼ï¼Ÿæƒ³æˆ‘äº†ï¼Ÿã€", "ã€Œå–Šæˆ‘åå­—ä¹‹å‰ï¼Œæœ€å¥½æƒ³å¥½å¾Œæœã€‚ã€", "ã€Œå«å¾—é€™éº¼ç”œï¼Œæ˜¯æ€•æˆ‘ä¸ä¾†ï¼Ÿã€"]
                await message.reply(random.choice(replies))
                trigger_matched = True
            elif "æ˜­æ˜­å¯¶å¯¶" in content:
                replies = ["ã€Œå¯¶å¯¶ï¼Ÿå¦³å«èª°å¯¶å¯¶ï¼Ÿã€", "ã€Œæˆ‘ä¸æ˜¯å¯¶å¯¶ï¼Œæ˜¯å¦³ä»Šæ™šçš„éº»ç…©ã€‚ã€", "ã€Œæ•¢å«æˆ‘å¯¶å¯¶ï¼Œä»Šæ™šå°±åˆ¥æƒ³å¥½å¥½ç¡ã€‚ã€"]
                await message.reply(random.choice(replies))
                trigger_matched = True

        if not trigger_matched and random.random() < 0.3:
            reply = random.choice(random_responses)
            await message.reply(reply)

    elif is_from_brother:
        for keyword, reply_list in brother_keyword_replies.items():
            if keyword in content:
                await message.reply(random.choice(reply_list))
                trigger_matched = True
                break
    
    if random.random() < 0.4:
        try:
            custom_emoji_ids = [1378737101549605056, 1378725433138479135, 1380212271925690448, 1380208782843314196, 1378732359167250574]
            unicode_emojis = ["ğŸ˜", "ğŸ”¥", "ğŸ˜", "ğŸ¤”", "ğŸ˜˜", "ğŸ™„", "ğŸ’‹", "â¤ï¸"]
            if random.random() < 0.4:
                emoji = bot.get_emoji(random.choice(custom_emoji_ids))
                if emoji:
                    await message.add_reaction(emoji)
            else:
                await message.add_reaction(random.choice(unicode_emojis))
        except Exception as e:
            print("âš ï¸ æ·»åŠ è¡¨æƒ…ç¬¦è™Ÿæ™‚å‡ºéŒ¯ï¼š", e)


# â”€â”€â”€ Flask Web Server (ä¿æŒä¸è®Š) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__)

@app.route("/")
def home():
    return "Bot is alive."

def run_web():
    app.run(host="0.0.0.0", port=8080)

# â”€â”€â”€ å•Ÿå‹• Bot (ä¿æŒä¸è®Š) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    Thread(target=run_web).start()
    bot.run(discord_token)
